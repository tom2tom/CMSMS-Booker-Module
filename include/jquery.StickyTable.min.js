/*!
StickyTable table header/column freezer
version 0.2
Copyright (C) 2014-2015 Tom Phane
Licensed under the GNU Affero GPL v.3 or, at the distributor's discretion, a later version of that license.
See http://www.gnu.org/licenses#AGPL.
*/
(function($,window){$.extend({StickyTable:new function(){function h(j,m,k){var i=j.css("background"),l=j.css("backgroundColor");if(i!==""){backs={background:i}}else{if(l!==m){backs={backgroundColor:l}}else{if(j.is("body")){backs={backgroundColor:k}}else{return h(j.parent(),m,k)}}}return backs}function d(q,n){if(q.indexOf("px")>-1){return q.replace("px","").trim()}if(q.indexOf("em")>-1){var j=$('<div style="display:none; font-size:1em; margin:0; padding:0; border:0; height:auto; line-height:1;">&nbsp;</div>').appendTo(n),i=j.height(),k=parseFloat(q.replace("em","").trim());j.remove();return i*k}if(q.indexOf("%")>-1){var l=$('<div style="display:none;width:1000px;"><div style="width:10%;">&nbsp;</div></div>').appendTo(n),o=l.width(),p=l.children().eq(0).width(),m=o*(p/100);k=parseFloat(q.replace("%","").trim());l.remove();return m*k}return parseInt(q)}function e(i){var k;if(i.stuckHead){i.original.find("thead th").each(function(l){k=$(this).width()-0.4;i.stuckHead.find("th").eq(l).width(k)})}if(i.stuckLeft){i.original.find("tr").each(function(l){k=$(this).height()-1;i.stuckLeft.find("tr").eq(l).height(k)})}if(i.stuckHL){k=0;var j=0;i.stuckLeft.find("thead tr").each(function(l){if(l==0){j=$(this).width()}k+=$(this).height()});i.stuckHL.height(k).width(j)}}function g(i){if(i.original.height()>i.wrapper.height()){var l=0;if(i.wrapper.scrollTop()>0){var j=i.wrapper.scrollTop()+0.1;i.stuckHead.css({top:j,left:l})}else{j=0.5;i.stuckHead.css({top:-200})}if(i.stickLeft){i.stuckHL.css({top:j,left:l})}}else{if(i.win.scrollTop()>i.original.offset().top){var k=0;i.original.find("tbody tr:lt(3)").each(function(){k+=i.original.height()});if(k>i.win.height()*0.25){k=i.win.height()*0.25}k+=i.stuckHead.height();if(i.win.scrollTop()<i.original.offset().top+i.original.outerHeight()-k){j=i.win.scrollTop()-i.original.offset().top;l=0;i.stuckHead.css({top:j,left:l});if(i.stickLeft){i.stuckHL.css({top:j,left:l})}return}}i.stuckHead.css({top:-200});if(i.stickLeft){i.stuckHL.css({top:-200,left:-200})}}}function b(i){if(i.original.width()>i.wrapper.width()){if(i.wrapper.scrollLeft()>0){var l=i.wrapper.scrollLeft();i.stuckLeft.css({top:0,left:l});if(i.stickTop){var k=i.wrapper.scrollTop()+1,j=i.wrapper.scrollLeft();i.stuckHL.css({top:k,left:j})}return}else{i.stuckLeft.css({left:-200})}}if(i.stickTop){i.stuckHL.css({top:-200,left:-200})}}function f(i){if(i.original.height()>i.wrapper.height()){if(i.wrapper.scrollTop()<XX){}else{}}}function c(i){if(i.original.width()>i.wrapper.width()){if(i.wrapper.scrollLeft()<XX){}else{}}}function a(i){if(i.stickTop){g(i)}if(i.stickLeft){b(i)}if(i.stickBtm){f(i)}if(i.stickRight){c(i)}}this.defaults={stickTop:true,stickLeft:false,stickBtm:false,stickRight:false,numLeft:1,numRight:1,width:null,height:null,overflowx:true,overflowy:true,copyTableClass:true,copyEvents:true};this.sizetimer=0;this.construct=function(i){var j={win:null,wrapper:null,original:null,stuckHead:null,stuckLeft:null,stuckFoot:null,stuckRight:null,stuckHL:null,stuckHR:null,stuckFL:null,stuckFR:null,wrapped:true};this.each(function(){var K=$(this);if(!K.is("table")){$.error("Target element must be a table");return this}if(K.hasClass("sticky-enabled")){return this}var n=$.extend({},j,$.StickyTable.defaults,i||{});if(n.stickTop){if(K.find("thead").length<1||K.find("thead th").length<1){n.stickTop=false}}if(n.stickBtm){if(K.find("tfoot").length<1||K.find("tfoot td").length<1){n.stickBtm=false}}if(n.stickLeft){if(n.numLeft<1){n.stickLeft=false}else{var v=0;K.find("tbody tr:nth-child(1) td").each(function(){if($(this).attr("colspan")){v+=$(this).attr("colspan")}else{v++}});if(v<2){n.stickLeft=false}}}if(n.stickRight){if(n.numRight<1){n.stickRight=false}else{if(!n.stickLeft){v=0;K.find("tbody tr:nth-child(1) td").each(function(){if($(this).attr("colspan")){v+=$(this).attr("colspan")}else{v++}});if(v<2){n.stickRight=false}}}}if(!(n.stickTop||n.stickLeft||n.stickBtm||n.stickRight)){return this}n.win=$(window);n.original=K.css({margin:"","margin-top":"","margin-right":"","margin-bottom":"","margin-left":""});var x=K.parent();if(x.is("div")&&x.children().length==1){x.css({padding:"","padding-top":"","padding-right":"","padding-bottom":"","padding-left":"",overflow:"","overflow-x":"","overflow-y":""});n.wrapped=false}else{K.wrap("<div />");x=original.parent();n.wrapped=true}n.wrapper=x.addClass("stk-wrap");if(n.width){var p=d(n.width,n.wrapper),F=K.outerWidth(),r=min(F,p)+"px";n.wrapper.css("width",r)}if(n.overflowx){n.wrapper.addClass("overflow-x")}if(n.height){var J=d(n.height,n.wrapper),o=K.outerHeight(),E=min(o,J)+"px";n.wrapper.css("height",E)}if(n.overflowy){n.wrapper.addClass("overflow-y")}x=$('<div style="background:none;display:none;"/>').appendTo(n.wrapper);var I=x.css("backgroundColor");x.remove();var H,m,s,k,A,u,y,q,t,z,C,B,G,l,D;if(n.stickLeft&&n.stickTop){H=this.cloneNode(false);n.stuckHL=$(H).removeAttr("id").addClass("stk-tl");n.wrapper.append(n.stuckHL);t="";for(D=0;D<n.numLeft-1;D++){t+="th:eq("+D+"),"}t+="th:eq("+D+")";B=null;s=n.stuckHL;K.find("thead tr").each(function(w){if(!B){s.append("<thead />");B=s.find("thead")}l=B;C=t;A=$(this).find(C);y=h(A,I,"#FFF");x=A.clone(n.copyEvents);l.append($("<tr />").css(y).append(x))})}if(n.stickTop){H=this.cloneNode(false);n.stuckHead=$(H).removeAttr("id").addClass("stk-top");n.wrapper.append(n.stuckHead);m=K.find("thead");s=m.clone(n.copyEvents);k=m.find("tr");s.find("tr").each(function(w){A=k.eq(w);y=h(A,I,"#FFF");$(this).css(y)});k=m.find("th");s.find("th").each(function(w){A=k.eq(w);$(this).css("width",A.width())});n.stuckHead.append(s)}if(n.stickLeft){H=this.cloneNode(false);n.stuckLeft=$(H).removeAttr("id").addClass("stk-left");n.wrapper.append(n.stuckLeft);t="";z="";for(D=0;D<n.numLeft-1;D++){t+="th:eq("+D+"),";z+="td:eq("+D+"),"}t+="th:eq("+D+")";z+="td:eq("+D+")";B=null;G=null;s=n.stuckLeft;K.find("tr").each(function(w){A=$(this);if(A.parent().is("thead")){if(!B){s.append("<thead />");B=s.find("thead")}l=B;C=t}else{if(!G){s.append("<tbody />");G=s.find("tbody")}l=G;C=z}y=h(A,I,"#FFF");x=A.find(C).clone(n.copyEvents);l.append($("<tr />").css(y).append(x))})}e(n);K.css({margin:0,"max-width":"100%"}).addClass("sticky-enabled");n.wrapper.scroll(function(w){a(n)});n.win.resize(function(){if(this.sizetimer==0){e(n);a(n);this.sizetimer=setTimeout(function(){this.sizetimer=0},250)}}).scroll(function(w){a(n)})});return this}}});$.fn.extend({StickyTable:$.StickyTable.construct})})(jQuery,window);