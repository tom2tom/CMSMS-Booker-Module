/*!
StickyTable table header/column freezer
version 0.2
Copyright (C) 2014-2015 Tom Phane
Licensed under the GNU Affero GPL v.3 or, at the distributor's discretion, a later version of that license.
See http://www.gnu.org/licenses#AGPL.
*/
(function(b,a){b.extend({StickyTable:new function(){function j(l,o,m){var k=l.css("background"),n=l.css("backgroundColor");if(k!==""){backs={background:k}}else{if(n!==o){backs={backgroundColor:n}}else{if(l.is("body")){backs={backgroundColor:m}}else{return j(l.parent(),o,m)}}}return backs}function f(s,p){if(s.indexOf("px")>-1){return s.replace("px","").trim()}if(s.indexOf("em")>-1){var l=b('<div style="display:none; font-size:1em; margin:0; padding:0; border:0; height:auto; line-height:1;">&nbsp;</div>').appendTo(p),k=l.height(),m=parseFloat(s.replace("em","").trim());l.remove();return k*m}if(s.indexOf("%")>-1){var n=b('<div style="display:none;width:1000px;"><div style="width:10%;">&nbsp;</div></div>').appendTo(p),q=n.width(),r=n.children().eq(0).width(),o=q*(r/100);m=parseFloat(s.replace("%","").trim());n.remove();return o*m}return parseInt(s)}function g(k){var m;if(k.stuckHead){k.original.find("thead th").each(function(n){m=b(this).width();k.stuckHead.find("th").eq(n).width(m)});k.stuckHead.width(k.original.width())}if(k.stuckLeft){k.original.find("tr").each(function(n){m=b(this).height();k.stuckLeft.find("tr").eq(n).height(m)})}if(k.stuckHL){m=0;var l=0;k.stuckLeft.find("thead tr").each(function(n){if(n==0){l=b(this).width()}m+=b(this).height()});k.stuckHL.height(m).width(l)}}function i(k){if(k.original.height()>k.wrapper.height()){if(k.wrapper.scrollTop()>0){var l=k.wrapper.scrollTop(),n=0;k.stuckHead.css({top:l,left:n});l+=1}else{l=1;k.stuckHead.css({top:-200})}if(k.stickLeft){k.stuckHL.css({top:l,left:n})}}else{if(k.win.scrollTop()>k.original.offset().top){var m=0;k.original.find("tbody tr:lt(3)").each(function(){m+=k.original.height()});if(m>k.win.height()*0.25){m=k.win.height()*0.25}m+=k.stuckHead.height();if(k.win.scrollTop()<k.original.offset().top+k.original.outerHeight()-m){l=k.win.scrollTop()-k.original.offset().top;n=0;k.stuckHead.css({top:l,left:n});if(k.stickLeft){k.stuckHL.css({top:l,left:n})}return}}k.stuckHead.css({top:-200});if(k.stickLeft){k.stuckHL.css({top:-200,left:-200})}}}function d(k){if(k.original.width()>k.wrapper.width()){if(k.wrapper.scrollLeft()>0){var n=k.wrapper.scrollLeft();k.stuckLeft.css({top:0,left:n});if(k.stickTop){var m=k.wrapper.scrollTop(),l=k.wrapper.scrollLeft();k.stuckHL.css({top:m,left:l})}return}else{k.stuckLeft.css({left:-200})}}if(k.stickTop){k.stuckHL.css({top:-200,left:-200})}}function h(k){if(k.original.height()>k.wrapper.height()){if(k.wrapper.scrollTop()<XX){}else{}}}function e(k){if(k.original.width()>k.wrapper.width()){if(k.wrapper.scrollLeft()<XX){}else{}}}function c(k){if(k.stickTop){i(k)}if(k.stickLeft){d(k)}if(k.stickBtm){h(k)}if(k.stickRight){e(k)}}this.defaults={stickTop:true,stickLeft:false,stickBtm:false,stickRight:false,numLeft:1,numRight:1,width:null,height:null,overflowx:true,overflowy:true,copyTableClass:true,copyEvents:true};this.sizetimer=0;this.construct=function(k){var l={win:null,wrapper:null,original:null,stuckHead:null,stuckLeft:null,stuckFoot:null,stuckRight:null,stuckHL:null,stuckHR:null,stuckFL:null,stuckFR:null,wrapped:true};this.each(function(){var M=b(this);if(!M.is("table")){b.error("Target element must be a table");return this}if(M.hasClass("sticky-enabled")){return this}var p=b.extend({},l,b.StickyTable.defaults,k||{});if(p.stickTop){if(M.find("thead").length<1||M.find("thead th").length<1){p.stickTop=false}}if(p.stickBtm){if(M.find("tfoot").length<1||M.find("tfoot td").length<1){p.stickBtm=false}}if(p.stickLeft){if(p.numLeft<1){p.stickLeft=false}else{var y=0;M.find("tbody tr:nth-child(1) td").each(function(){if(b(this).attr("colspan")){y+=b(this).attr("colspan")}else{y++}});if(y<2){p.stickLeft=false}}}if(p.stickRight){if(p.numRight<1){p.stickRight=false}else{if(!p.stickLeft){y=0;M.find("tbody tr:nth-child(1) td").each(function(){if(b(this).attr("colspan")){y+=b(this).attr("colspan")}else{y++}});if(y<2){p.stickRight=false}}}}if(!(p.stickTop||p.stickLeft||p.stickBtm||p.stickRight)){return this}p.win=b(a);p.original=M.css({margin:"","margin-top":"","margin-right":"","margin-bottom":"","margin-left":""});var z=M.parent();if(z.is("div")&&z.children().length==1){z.css({padding:"","padding-top":"","padding-right":"","padding-bottom":"","padding-left":"",overflow:"","overflow-x":"","overflow-y":""});p.wrapped=false}else{M.wrap("<div />");z=original.parent();p.wrapped=true}p.wrapper=z.addClass("stk-wrap");if(p.width){var r=f(p.width,p.wrapper),H=M.outerWidth(),t=min(H,r)+"px";p.wrapper.css("width",t)}if(p.overflowx){p.wrapper.addClass("overflow-x")}if(p.height){var L=f(p.height,p.wrapper),q=M.outerHeight(),G=min(q,L)+"px";p.wrapper.css("height",G)}if(p.overflowy){p.wrapper.addClass("overflow-y")}z=b('<div style="background:none;display:none;"/>').appendTo(p.wrapper);var K=z.css("backgroundColor");z.remove();var J,o,u,m,C,x,A,s,v,B,E,D,I,n,F;if(p.stickLeft&&p.stickTop){J=this.cloneNode(false);p.stuckHL=b(J).removeAttr("id").addClass("stk-tl");p.wrapper.append(p.stuckHL);v="";for(F=0;F<p.numLeft-1;F++){v+="th:eq("+F+"),"}v+="th:eq("+F+")";D=null;u=p.stuckHL;M.find("thead tr").each(function(w){if(!D){u.append("<thead />");D=u.find("thead")}n=D;E=v;C=b(this).find(E);A=j(C,K,"#FFF");z=C.clone(p.copyEvents);n.append(b("<tr />").css(A).append(z))})}if(p.stickTop){J=this.cloneNode(false);p.stuckHead=b(J).removeAttr("id").addClass("stk-top");p.wrapper.append(p.stuckHead);o=M.find("thead");u=o.clone(p.copyEvents);m=o.find("tr");u.find("tr").each(function(w){C=m.eq(w);A=j(C,K,"#FFF");b(this).css(A)});m=o.find("th");u.find("th").each(function(w){C=m.eq(w);b(this).css("width",C.width())});p.stuckHead.append(u)}if(p.stickLeft){J=this.cloneNode(false);p.stuckLeft=b(J).removeAttr("id").addClass("stk-left");p.wrapper.append(p.stuckLeft);v="";B="";for(F=0;F<p.numLeft-1;F++){v+="th:eq("+F+"),";B+="td:eq("+F+"),"}v+="th:eq("+F+")";B+="td:eq("+F+")";D=null;I=null;u=p.stuckLeft;M.find("tr").each(function(w){C=b(this);if(C.parent().is("thead")){if(!D){u.append("<thead />");D=u.find("thead")}n=D;E=v}else{if(!I){u.append("<tbody />");I=u.find("tbody")}n=I;E=B}A=j(C,K,"#FFF");z=C.find(E).clone(p.copyEvents);n.append(b("<tr />").css(A).append(z))})}g(p);M.css({margin:0,"max-width":"100%"}).addClass("sticky-enabled");p.wrapper.scroll(function(w){c(p)});p.win.resize(function(){if(this.sizetimer==0){g(p);c(p);this.sizetimer=setTimeout(function(){this.sizetimer=0},250)}}).scroll(function(w){c(p)})});return this}}});b.fn.extend({StickyTable:b.StickyTable.construct})})(jQuery,window);